<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ajout d'un bénéficiaire</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    .input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
    }
    .label-required::after {
      content: " *";
      color: red;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 pt-6">
  <div class="max-w-5xl mx-auto p-8 bg-white shadow-2xl rounded-2xl mt-10">
    <h1 class="text-3xl font-bold mb-6 text-center">Ajout d'un bénéficiaire</h1>

    <section class="mb-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label-required">Expérimentation générale</label>
          <select id="selectExperimentation" class="input" required>
            <option value="">Sélectionner...</option>
            {% for exp in experimentations %}
              <option value="{{ exp.id }}">{{ exp.nom }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="label-required">Cible</label>
          <select id="selectCible" class="input">
            <option value="">Choisir...</option>
          </select>
        </div>
      </div>

      <div class="mt-6">
        <label class="label-required">Statut</label>
        <select id="selectStatut" class="input" disabled>
          <option value="">Sélectionner une expérimentation et une cible</option>
        </select>
      </div>

      <div id="zoneChampsStatut" class="mt-6"></div>
    </section>
  </div>
  
  <script>
    let statutsData = [];

    async function chargerStatuts() {
      const experimentationId = document.getElementById("selectExperimentation").value;
      const cible = document.getElementById("selectCible").value;
      const statutSelect = document.getElementById("selectStatut");
      const champsZone = document.getElementById("zoneChampsStatut");

      champsZone.innerHTML = "";
      statutSelect.innerHTML = '<option value="">Chargement...</option>';
      statutSelect.disabled = true;

      if (!experimentationId || !cible) return;

      try {
        const res = await fetch(`/api/statuts-champs/?experimentation_id=${experimentationId}&cible=${cible}`);
        const data = await res.json();

        if (data.success) {
          statutsData = data.statuts;
          statutSelect.innerHTML = '<option value="">Sélectionner un statut</option>';
          data.statuts.forEach((s, index) => {
            const opt = document.createElement("option");
            opt.value = index;
            opt.textContent = s.nom_statut;
            statutSelect.appendChild(opt);
          });
          statutSelect.disabled = false;
        } else {
          statutSelect.innerHTML = `<option value="">Erreur : ${data.error}</option>`;
        }
      } catch (err) {
        statutSelect.innerHTML = `<option value="">Erreur réseau</option>`;
      }
    }

    document.getElementById("selectExperimentation").addEventListener("change", async function () {
      const experimentationId = this.value;
      const cibleSelect = document.getElementById("selectCible");

      cibleSelect.innerHTML = '<option value="">Chargement...</option>';
      document.getElementById("selectStatut").innerHTML = '';
      document.getElementById("zoneChampsStatut").innerHTML = '';

      if (!experimentationId) return;

      try {
        const res = await fetch(`/api/cibles/?experimentation_id=${experimentationId}`);
        const data = await res.json();

        if (data.success) {
          cibleSelect.innerHTML = '<option value="">Choisir...</option>';
          data.cibles.forEach(cible => {
            const opt = document.createElement("option");
            opt.value = cible;
            opt.textContent = cible.charAt(0).toUpperCase() + cible.slice(1);
            cibleSelect.appendChild(opt);
          });
        } else {
          cibleSelect.innerHTML = '<option value="">Erreur chargement</option>';
        }
      } catch (err) {
        cibleSelect.innerHTML = '<option value="">Erreur réseau</option>';
      }
    });

    document.getElementById("selectCible").addEventListener("change", chargerStatuts);

    document.getElementById("selectStatut").addEventListener("change", function () {
      const index = this.value;
      const champsZone = document.getElementById("zoneChampsStatut");
      champsZone.innerHTML = "";

      if (index === "") return;

      const selectedStatut = statutsData[parseInt(index)];
      selectedStatut.champs.forEach(champ => {
        champsZone.innerHTML += `
          <div class="mb-4">
            <label class="block font-medium">${champ} *</label>
            <input type="text" name="champ_${selectedStatut.nom_statut}_${champ}" class="input" required>
          </div>
        `;
      });
    });
  </script>
</body>
</html>
